<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>å¤šè¯­è¨€æœ¬åœŸåŒ–ç¿»è¯‘</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  body { font-family: 'Inter', sans-serif; }
  .lucide { vertical-align: middle; }
  .dragging { opacity: 0.5; transform: scale(0.95); }
  
  /* é’ˆå¯¹å°å±å¹•çš„å¾®è°ƒ */
  @media (max-height: 800px) {
    .compact-hide { display: none; }
    .container-padding { padding: 1.5rem !important; }
  }
</style>
</head>
<body class="bg-slate-50 min-h-screen p-3 md:p-8 relative selection:bg-purple-200 selection:text-purple-900 flex flex-col items-center">

  <!-- èƒŒæ™¯è£…é¥° -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
    <!-- å·¦ä¸Šè§’ç´«è‰² -->
    <div class="absolute top-[-10%] left-[-10%] w-[50vw] h-[50vw] bg-purple-300/30 rounded-full blur-[120px]"></div>
    <!-- å³ä¸‹è§’è“è‰² -->
    <div class="absolute bottom-[-10%] right-[-10%] w-[50vw] h-[50vw] bg-blue-300/30 rounded-full blur-[120px]"></div>
    <!-- ä¸­å¤®æ··åˆå…‰æ™• -->
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[80vw] h-[80vh] bg-gradient-to-tr from-purple-100/40 to-blue-100/40 rounded-full blur-[100px] opacity-80"></div>
  </div>

  <!-- ä¸»å®¹å™¨ï¼šå®½åº¦è°ƒæ•´ä¸º max-w-[92%] é€‚é…å¤§å±ï¼Œæœ€å¤§é™åˆ¶ 1600px -->
  <div class="container max-w-[92%] 2xl:max-w-[1600px] w-full transition-all duration-300">
    <!-- å¢åŠ  padding (p-8 md:p-10) è®©å†…å®¹æ›´èˆ’å±• -->
    <div class="bg-white/30 backdrop-blur-2xl rounded-[32px] border border-white/40 shadow-[0_8px_30px_rgba(0,0,0,0.04)] p-6 md:p-10 relative overflow-hidden ring-1 ring-white/40">
      
      <!-- é¡¶éƒ¨è£…é¥°æ¡ -->
      <div class="absolute top-0 left-1/2 -translate-x-1/2 w-20 h-1.5 bg-white/50 rounded-b-lg backdrop-blur-md"></div>

      <!-- æ ‡é¢˜åŒº -->
      <div class="flex items-center justify-between mb-6 border-b border-white/30 pb-5">
        <div class="flex items-center gap-5">
          <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-white/60 shadow-sm border border-white/50 backdrop-blur-md shrink-0 transition-transform hover:scale-105 duration-300">
            <i data-lucide="languages" class="w-7 h-7 text-purple-600"></i>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-slate-800 tracking-tight leading-tight">å¤šè¯­è¨€æœ¬åœŸåŒ–ç¿»è¯‘</h1>
            <div class="flex items-center gap-3 mt-1.5">
               <span class="text-xs font-semibold text-slate-500 bg-white/40 px-2.5 py-0.5 rounded-md border border-white/30 shadow-sm">è¾“å…¥: è‹±æ–‡</span>
               <span class="text-[11px] text-slate-400 hidden md:inline-block tracking-wide">| AI-Powered Localization Tool</span>
            </div>
          </div>
        </div>
        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div id="status" class="hidden md:flex px-4 py-2 rounded-xl bg-white/40 border border-white/40 text-slate-600 text-xs font-medium items-center gap-2.5 backdrop-blur-md shadow-sm">
          <span class="w-2 h-2 rounded-full bg-slate-400"></span>
          å¾…æœºä¸­
        </div>
      </div>

      <!-- æ ¸å¿ƒè®¾ç½®è¡Œ (é—´è· gap-6) -->
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-6">
        <!-- æ‰¹å¤§å° -->
        <div class="md:col-span-2 2xl:col-span-1">
          <div class="relative group h-full">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i data-lucide="layers" class="w-5 h-5 text-slate-400 transition-colors group-focus-within:text-purple-500"></i>
            </div>
            <!-- é«˜åº¦è°ƒå› h-12 -->
            <input type="number" id="batchSize" value="50" min="1" max="500" placeholder="Batch" title="æ‰¹å¤§å°"
              class="w-full h-12 pl-11 pr-3 bg-white/40 border border-transparent rounded-xl text-slate-700 text-base hover:bg-white/60 focus:bg-white/90 focus:ring-2 focus:ring-purple-200 transition-all outline-none shadow-sm font-medium">
          </div>
        </div>

        <!-- API Key -->
        <div class="md:col-span-10 2xl:col-span-11">
          <div class="relative group h-full">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i data-lucide="key" class="w-5 h-5 text-slate-400 transition-colors group-focus-within:text-purple-500"></i>
            </div>
            <!-- é«˜åº¦è°ƒå› h-12 -->
            <input type="password" id="userApiKey" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ API Key (sk-...)" 
              class="w-full h-12 pl-11 pr-4 bg-white/40 border border-transparent rounded-xl text-slate-700 text-base hover:bg-white/60 focus:bg-white/90 focus:ring-2 focus:ring-purple-200 transition-all outline-none shadow-sm font-mono tracking-wide">
          </div>
        </div>
      </div>
      
      <!-- è¾“å…¥æºæ–‡æœ¬ (ç¨å¾®å¢é«˜ min-h) -->
      <div class="mb-6 relative group">
        <div class="absolute top-3 right-3 pointer-events-none z-10">
            <span class="text-[10px] text-slate-400 font-bold bg-white/50 px-2 py-1 rounded-lg border border-white/30">SOURCE TEXT</span>
        </div>
        <textarea id="sourceText" placeholder="è¾“å…¥å¾…ç¿»è¯‘è¯æ±‡ (æ¯è¡Œä¸€ä¸ª)&#10;ä¾‹å¦‚ï¼š&#10;AI Stem Splitter&#10;Free Key and BPM Finder"
            class="w-full p-5 min-h-[160px] bg-white/40 border border-transparent rounded-2xl text-slate-700 placeholder-slate-400 hover:bg-white/60 focus:bg-white/80 focus:border-purple-200 focus:ring-4 focus:ring-purple-100/50 transition-all outline-none shadow-sm resize-y font-sans text-sm leading-relaxed backdrop-blur-sm"></textarea>
      </div>

      <!-- è¾…åŠ©åŠŸèƒ½åŒº (é—´è· gap-6) -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- å·¦ä¾§ï¼šç¤ºä¾‹ -->
        <div class="bg-white/30 rounded-2xl p-4 border border-white/40 shadow-sm backdrop-blur-md ring-1 ring-white/20 flex flex-col transition-all hover:bg-white/40">
          <div class="flex justify-between items-center mb-3">
            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5">
              <i data-lucide="sparkles" class="w-3.5 h-3.5 text-yellow-500"></i> ç¤ºä¾‹ (Few-Shot)
            </label>
            <div class="flex gap-2">
                <select id="examplePreset" class="text-xs bg-white/50 border-none rounded-lg px-2.5 py-1 text-slate-700 shadow-sm cursor-pointer hover:bg-white/80 focus:ring-1 focus:ring-purple-200 outline-none transition-colors font-medium">
                  <option value="">åŠ è½½é¢„è®¾...</option>
                  <option value="music">ğŸµ éŸ³ä¹åœºæ™¯</option>
                  <option value="coloring">ğŸ¨ å¡«è‰²åœºæ™¯</option>
                </select>
                <button id="previewExampleBtn" class="text-xs bg-white/50 px-3 py-1 rounded-lg text-slate-600 hover:text-purple-600 hover:bg-white transition-all border border-transparent hover:border-purple-100 font-medium shadow-sm">
                    é¢„è§ˆè¡¨æ ¼
                </button>
            </div>
          </div>
          <textarea id="bestExamples" placeholder="ç¤ºä¾‹æ ¼å¼ï¼š&#10;AI Stem Splitter => AI éŸ³è½¨åˆ†ç¦»å™¨"
            class="w-full p-4 h-24 bg-white/40 border border-transparent rounded-xl text-slate-700 placeholder-slate-400 focus:bg-white/80 focus:ring-2 focus:ring-purple-100/50 transition-all outline-none text-xs resize-none hover:bg-white/60"></textarea>
        </div>

        <!-- å³ä¾§ï¼šæç¤ºè¯ -->
        <div class="bg-white/30 rounded-2xl p-4 border border-white/40 shadow-sm backdrop-blur-md ring-1 ring-white/20 flex flex-col transition-all hover:bg-white/40">
          <div class="flex justify-between items-center mb-3">
             <label class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5">
              <i data-lucide="message-square-dashed" class="w-3.5 h-3.5 text-blue-500"></i> ç³»ç»Ÿæç¤ºè¯ (System Prompt)
            </label>
            <select id="presetPrompt" class="text-xs bg-white/50 border-none rounded-lg px-2.5 py-1 text-slate-700 shadow-sm cursor-pointer hover:bg-white/80 focus:ring-1 focus:ring-purple-200 outline-none transition-colors font-medium">
              <option value="">åŠ è½½é¢„è®¾...</option>
              <option value="music">ğŸµ éŸ³ä¹é£æ ¼</option>
              <option value="coloring">ğŸ¨ å¡«è‰²é£æ ¼</option>
            </select>
          </div>
          <textarea id="customPrompt" placeholder="ä¾‹å¦‚ï¼šè¯·ä¿æŒä¸“ä¸šè¯­æ°”ï¼Œé‡åˆ°ä¸“æœ‰åè¯ä¿ç•™è‹±æ–‡..."
            class="w-full p-4 h-24 bg-white/40 border border-transparent rounded-xl text-slate-700 placeholder-slate-400 focus:bg-white/80 focus:ring-2 focus:ring-purple-100/50 transition-all outline-none text-xs resize-none hover:bg-white/60"></textarea>
        </div>
      </div>

      <!-- åº•éƒ¨å·¥å…·æ  -->
      <div class="flex flex-col lg:flex-row items-end lg:items-center gap-6 border-t border-white/30 pt-6">
        
        <!-- æ‹–æ‹½æ’åº -->
        <div class="flex-1 w-full">
            <div class="text-[11px] font-bold text-slate-400 uppercase mb-3 ml-1 tracking-wider">è¾“å‡ºåˆ—é¡ºåº (æ‹–æ‹½è°ƒæ•´)</div>
            <ul id="headerList" class="flex flex-wrap gap-2.5">
              <li draggable="true" data-code="zh" class="cursor-grab active:cursor-grabbing bg-white/60 text-slate-700 px-3.5 py-2 rounded-lg border border-white/50 shadow-sm text-xs font-bold hover:bg-white hover:border-purple-200 hover:text-purple-600 hover:shadow-md hover:-translate-y-0.5 transition-all select-none flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-red-400"></span> zh
              </li>
              <li draggable="true" data-code="ja" class="cursor-grab active:cursor-grabbing bg-white/60 text-slate-700 px-3.5 py-2 rounded-lg border border-white/50 shadow-sm text-xs font-bold hover:bg-white hover:border-purple-200 hover:text-purple-600 hover:shadow-md hover:-translate-y-0.5 transition-all select-none flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-pink-400"></span> ja
              </li>
              <li draggable="true" data-code="de" class="cursor-grab active:cursor-grabbing bg-white/60 text-slate-700 px-3.5 py-2 rounded-lg border border-white/50 shadow-sm text-xs font-bold hover:bg-white hover:border-purple-200 hover:text-purple-600 hover:shadow-md hover:-translate-y-0.5 transition-all select-none flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-yellow-400"></span> de
              </li>
              <li draggable="true" data-code="pt" class="cursor-grab active:cursor-grabbing bg-white/60 text-slate-700 px-3.5 py-2 rounded-lg border border-white/50 shadow-sm text-xs font-bold hover:bg-white hover:border-purple-200 hover:text-purple-600 hover:shadow-md hover:-translate-y-0.5 transition-all select-none flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span> pt
              </li>
              <li draggable="true" data-code="es" class="cursor-grab active:cursor-grabbing bg-white/60 text-slate-700 px-3.5 py-2 rounded-lg border border-white/50 shadow-sm text-xs font-bold hover:bg-white hover:border-purple-200 hover:text-purple-600 hover:shadow-md hover:-translate-y-0.5 transition-all select-none flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-orange-400"></span> es
              </li>
              <li draggable="true" data-code="fr" class="cursor-grab active:cursor-grabbing bg-white/60 text-slate-700 px-3.5 py-2 rounded-lg border border-white/50 shadow-sm text-xs font-bold hover:bg-white hover:border-purple-200 hover:text-purple-600 hover:shadow-md hover:-translate-y-0.5 transition-all select-none flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span> fr
              </li>
              <li draggable="true" data-code="ko" class="cursor-grab active:cursor-grabbing bg-white/60 text-slate-700 px-3.5 py-2 rounded-lg border border-white/50 shadow-sm text-xs font-bold hover:bg-white hover:border-purple-200 hover:text-purple-600 hover:shadow-md hover:-translate-y-0.5 transition-all select-none flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-teal-400"></span> ko
              </li>
              <li draggable="true" data-code="tw" class="cursor-grab active:cursor-grabbing bg-white/60 text-slate-700 px-3.5 py-2 rounded-lg border border-white/50 shadow-sm text-xs font-bold hover:bg-white hover:border-purple-200 hover:text-purple-600 hover:shadow-md hover:-translate-y-0.5 transition-all select-none flex items-center gap-1.5">
                 <span class="w-1.5 h-1.5 rounded-full bg-red-300"></span> tw
              </li>
              <li draggable="true" data-code="vi" class="cursor-grab active:cursor-grabbing bg-white/60 text-slate-700 px-3.5 py-2 rounded-lg border border-white/50 shadow-sm text-xs font-bold hover:bg-white hover:border-purple-200 hover:text-purple-600 hover:shadow-md hover:-translate-y-0.5 transition-all select-none flex items-center gap-1.5">
                 <span class="w-1.5 h-1.5 rounded-full bg-red-600"></span> vi
              </li>
            </ul>
        </div>

        <!-- æŒ‰é’®ç»„ (é«˜åº¦è°ƒå› h-12) -->
        <div class="flex gap-3 w-full lg:w-auto mt-2 lg:mt-0">
          <button id="copyBtn" class="flex-1 lg:flex-none h-12 px-6 rounded-xl bg-white/60 text-purple-700 font-semibold border border-purple-100 shadow-sm hover:bg-white/80 hover:shadow-md hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 text-sm group">
            <i data-lucide="clipboard-check" class="w-4.5 h-4.5 group-hover:scale-110 transition-transform"></i> å¤åˆ¶ TSV
          </button>
          <button id="dlBtn" class="flex-1 lg:flex-none h-12 px-6 rounded-xl bg-white/60 text-slate-700 font-semibold border border-slate-100 shadow-sm hover:bg-white/80 hover:shadow-md hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 text-sm group">
            <i data-lucide="download" class="w-4.5 h-4.5 group-hover:scale-110 transition-transform"></i> ä¸‹è½½
          </button>
          <button id="runBtn" class="flex-[2] lg:flex-none h-12 px-10 rounded-xl bg-slate-800/90 text-white font-bold shadow-lg shadow-slate-400/30 hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2.5 text-sm backdrop-blur-md hover:bg-slate-900">
            <i data-lucide="rocket" class="w-5 h-5"></i> ç«‹å³ç¿»è¯‘
          </button>
        </div>
      </div>

      <!-- ç§»åŠ¨ç«¯å¯è§çš„çŠ¶æ€æ¡ -->
      <div id="statusMobile" class="md:hidden mt-5 p-3 rounded-xl bg-white/40 border border-white/40 text-slate-600 text-xs font-medium flex items-center gap-2 backdrop-blur-md shadow-sm">
        <span class="w-2 h-2 rounded-full bg-slate-400"></span>
        å¾…æœºä¸­
      </div>

    </div>

    <!-- ç»“æœå±•ç¤ºåŒº -->
    <div class="result-section mt-6 bg-white/30 backdrop-blur-2xl rounded-[32px] border border-white/40 shadow-[0_8px_30px_rgba(0,0,0,0.04)] p-6 md:p-10 relative hidden ring-1 ring-white/30 transition-all" id="resultContainer">
      <h2 class="text-xl font-bold text-slate-800 mb-5 flex items-center gap-2.5">
        <div class="p-2 bg-green-100/80 rounded-lg text-green-700 backdrop-blur-sm">
          <i data-lucide="table-2" class="w-5 h-5"></i>
        </div>
        ç¿»è¯‘ç»“æœ
      </h2>
      
      <div class="table-wrap overflow-x-auto rounded-2xl border border-white/40 shadow-sm bg-white/20 backdrop-blur-sm transition-all" id="tableWrap" style="display:none;">
        <table id="resultTable" class="w-full text-left border-collapse min-w-[800px]">
          <thead><tr class="bg-white/40 border-b border-white/30 text-xs uppercase text-slate-600 font-bold tracking-wider backdrop-blur-sm"></tr></thead>
          <tbody class="divide-y divide-white/30 text-sm text-slate-700"></tbody>
        </table>
      </div>
      <div class="text-[11px] text-slate-500 mt-4 flex items-center gap-1.5 font-medium bg-white/30 inline-flex px-3 py-1 rounded-full border border-white/20">
        <i data-lucide="info" class="w-3.5 h-3.5"></i>
        æ³¨ï¼šç©ºç™½å•å…ƒæ ¼æ ‡çº¢è¡¨ç¤ºå¯èƒ½æ¼è¯‘ã€‚
      </div>
    </div>
  </div>

  <!-- å…¨å±€ Toast é€šçŸ¥ -->
  <div class="toast fixed top-8 right-8 bg-slate-800/90 text-white px-6 py-3 rounded-2xl shadow-2xl text-sm font-medium flex items-center gap-3 opacity-0 translate-y-[-20px] transition-all duration-300 z-[100] backdrop-blur-md border border-white/10" id="toast">
    <i data-lucide="check-circle-2" class="w-5 h-5 text-green-400"></i>
    <span id="toastMsg">å·²å¤åˆ¶</span>
  </div>

  <!-- ç¤ºä¾‹é¢„è§ˆæ¨¡æ€æ¡† -->
  <div id="examplePreviewModal" class="fixed inset-0 z-[1000] hidden items-center justify-center bg-slate-900/30 backdrop-blur-md p-4 transition-all">
   <div class="bg-white/80 backdrop-blur-2xl rounded-[32px] w-full max-w-5xl max-h-[85vh] flex flex-col shadow-2xl border border-white/50 ring-1 ring-white/40">
      <div class="flex justify-between items-center p-6 border-b border-white/30">
       <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
         <i data-lucide="eye" class="w-5 h-5 text-purple-600"></i> æœ€ä½³ç¤ºä¾‹é¢„è§ˆ
       </h3>
        <button id="closePreviewBtn" class="w-8 h-8 rounded-full bg-white/50 text-slate-600 flex items-center justify-center hover:bg-white transition-colors backdrop-blur-sm shadow-sm">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
     </div>
      <div id="examplePreviewTableWrap" class="flex-1 overflow-auto p-6">
        <table id="examplePreviewTable" class="w-full text-left text-sm border-collapse min-w-[600px]">
          <thead></thead>
          <tbody></tbody>
       </table>
      </div>
   </div>
  </div>

<script>
// åˆå§‹åŒ–å›¾æ ‡
lucide.createIcons();

const API = "https://localize-proxy.ne0s0u1-pd.workers.dev";
const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));

// æ˜¾ç¤º Result Container
const resultContainer = document.getElementById('resultContainer');
// çŠ¶æ€æ ï¼šæœ‰ä¸¤ä¸ªï¼Œæ¡Œé¢ç«¯åœ¨å³ä¸Šè§’ï¼Œç§»åŠ¨ç«¯åœ¨åº•éƒ¨
const statusDesktop = document.getElementById("status");
const statusMobile = document.getElementById("statusMobile");

function updateStatus(html, className) {
  const innerContent = html;
  // æ›´æ–°æ¡Œé¢ç«¯
  if (statusDesktop) {
    statusDesktop.className = `hidden md:flex px-4 py-2 rounded-xl text-xs font-medium items-center gap-2.5 backdrop-blur-md shadow-sm border ${className}`;
    statusDesktop.innerHTML = innerContent;
  }
  // æ›´æ–°ç§»åŠ¨ç«¯
  if (statusMobile) {
    statusMobile.className = `md:hidden mt-5 p-3 rounded-xl text-xs font-medium flex items-center gap-2 backdrop-blur-md shadow-sm border ${className}`;
    statusMobile.innerHTML = innerContent;
  }
  lucide.createIcons();
}

function getBatchSize(){
  const elInput = document.getElementById("batchSize");
  const v = elInput ? parseInt(elInput.value,10) : 50;
  return Number.isFinite(v) && v > 0 ? v : 50;
}

const el = {
  src: document.getElementById("sourceText"),
  tableWrap: document.getElementById("tableWrap"),
  table: document.getElementById("resultTable"),
  theadRow: document.querySelector("#resultTable thead tr"),
  tbody: document.querySelector("#resultTable tbody"),
  runBtn: document.getElementById("runBtn"),
  copyBtn: document.getElementById("copyBtn"),
  dlBtn: document.getElementById("dlBtn"),
  toast: document.getElementById("toast"),
  toastMsg: document.getElementById("toastMsg")
};

const _userKeyInput = document.getElementById("userApiKey");
if (_userKeyInput) {
  _userKeyInput.value = localStorage.getItem("apicore_user_key") || "";
  _userKeyInput.addEventListener("input", () => {
    localStorage.setItem("apicore_user_key", _userKeyInput.value);
  });
}

const list = document.getElementById('headerList');
let dragItem = null;
list.addEventListener('dragstart', e => {
  dragItem = e.target.closest('li');
  if(dragItem) dragItem.classList.add('dragging');
});
list.addEventListener('dragend', e => {
  if(e.target.closest('li')) e.target.closest('li').classList.remove('dragging');
  dragItem = null;
});
list.addEventListener('dragover', e => {
  e.preventDefault();
  const target = e.target.closest('li');
  if (target && dragItem && target !== dragItem) {
    const rect = target.getBoundingClientRect();
    const next = (e.clientX - rect.left) / (rect.right - rect.left) > 0.5;
    list.insertBefore(dragItem, next ? target.nextSibling : target);
  }
});
function getHeaderOrder() {
  return Array.from(list.querySelectorAll('li')).map(li => li.dataset.code);
}

function showToast(msg){
  el.toastMsg.textContent = msg;
  el.toast.classList.remove("opacity-0", "translate-y-[-20px]");
  setTimeout(()=> el.toast.classList.add("opacity-0", "translate-y-[-20px]"), 2000);
}

function sanitizeKeepBr(html){
  return html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "");
}

function splitLines(s){
  return s.split(/\r?\n/).filter(line => line.trim().length>0);
}

function parseTSV(tsv){
  tsv = tsv.replace(/^```[\s\S]*?\n/,"").replace(/```$/,"").trim();
  const lines = tsv.split(/\r?\n/);
  return lines.map(line => line.split("\t"));
}

function renderTable(rows, inputLineCount){
  const header = rows[0] || [];
  el.theadRow.innerHTML = "";
  header.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    th.className = "px-6 py-4 bg-white/60 backdrop-blur sticky top-0 font-bold text-slate-600 border-b border-white/40 z-10";
    el.theadRow.appendChild(th);
  });

  el.tbody.innerHTML = "";
  const dataRows = rows.slice(1);
  let missingCount = 0;
  dataRows.forEach(cols => {
    const tr = document.createElement("tr");
    tr.className = "hover:bg-purple-50/40 transition-colors group";
    header.forEach((_, i) => {
      const td = document.createElement("td");
      const val = (cols[i] ?? "").trim();
      td.className = "px-6 py-4 border-b border-white/30 group-last:border-none align-top leading-relaxed text-slate-700";
      
      if (!val) { 
        td.classList.add("bg-red-50/60", "text-red-500"); 
        missingCount++; 
      }
      td.innerHTML = sanitizeKeepBr(val);
      tr.appendChild(td);
    });
    el.tbody.appendChild(tr);
  });

  resultContainer.classList.remove('hidden');
  el.tableWrap.style.display = "block";
  
  const outLines = dataRows.length;
  let statusHTML = "";
  let statusClass = "";

  if (outLines !== inputLineCount) {
    statusClass = "bg-red-50/60 text-red-600 border-red-100/50";
    statusHTML = `<i data-lucide="alert-triangle" class="w-4 h-4"></i> <span>è¡Œæ•°å¼‚å¸¸: ${inputLineCount}â†’${outLines}</span>`;
  } else if (missingCount > 0) {
    statusClass = "bg-orange-50/60 text-orange-600 border-orange-100/50";
    statusHTML = `<i data-lucide="alert-circle" class="w-4 h-4"></i> <span>${missingCount} ç©ºæ ¼</span>`;
  } else {
    statusClass = "bg-green-50/60 text-green-600 border-green-100/50";
    statusHTML = `<i data-lucide="check-circle" class="w-4 h-4"></i> <span>å®Œæˆ</span>`;
  }
  updateStatus(statusHTML, statusClass);
}

async function translateAndRender(){
  const input = el.src.value.trim();
  const examples = document.getElementById("bestExamples").value.trim();
  const customPrompt = (document.getElementById("customPrompt")?.value || "").trim();
  const inputLines = splitLines(input);
  if (!input){ showToast("è¯·è¾“å…¥è‹±æ–‡æ–‡æœ¬"); return; }

  const BATCH_SIZE = getBatchSize();
  
  updateStatus(`<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> <span>å‡†å¤‡ä¸­...</span>`, "bg-blue-50/60 text-blue-600 border-blue-100/50");

  el.tableWrap.style.display = "none"; 
  el.runBtn.disabled = true;
  el.runBtn.classList.add("opacity-70", "cursor-not-allowed");

  try {
    const total = inputLines.length; let offset = 0; let combinedTSV = "";
    const totalBatches = Math.ceil(total / BATCH_SIZE);
    for (let i=1;i<=totalBatches;i++){
      updateStatus(`<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> <span>æ‰¹æ¬¡ ${i}/${totalBatches}</span>`, "bg-purple-50/60 text-purple-600 border-purple-100/50");
      
      const res = await fetch(API,{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          text:inputLines.join("\n"),examples,customPrompt,
          headerOrder:getHeaderOrder(),offset,batchSize:BATCH_SIZE,
          userApiKey:(document.getElementById("userApiKey")?.value||"").trim()
        })
      });
      if(!res.ok) throw new Error("è¯·æ±‚å¤±è´¥");
      const data=await res.json();
      if(data.error){throw new Error(data.error.message||"åç«¯é”™è¯¯");}
      combinedTSV += (combinedTSV?"\n":"")+(data.table||"").trim();
      offset += BATCH_SIZE; await sleep(1500);
    }
    const rows=parseTSV(combinedTSV);
    renderTable(rows,inputLines.length);
    el.tableWrap.dataset.tsv=rows.map(r=>r.join("\t")).join("\n");
  }catch(e){
    updateStatus(`<i data-lucide="x-circle" class="w-4 h-4"></i> <span>å¤±è´¥</span>`, "bg-red-50/60 text-red-600 border-red-100/50");
    showToast(e.message);
  }finally{
    el.runBtn.disabled=false;
    el.runBtn.classList.remove("opacity-70", "cursor-not-allowed");
  }
}

async function robustCopy(text){
  if(navigator.clipboard&&navigator.clipboard.writeText){await navigator.clipboard.writeText(text);return;}
  const ta=document.createElement("textarea");
  ta.value=text;ta.style.position="absolute";ta.style.left="-9999px";document.body.appendChild(ta);
  ta.select();document.execCommand("copy");document.body.removeChild(ta);
}

el.runBtn.addEventListener("click",translateAndRender);
el.copyBtn.addEventListener("click",async()=>{
  const tsv=el.tableWrap.dataset.tsv||"";const lines=tsv.split(/\r?\n/);
  const noHeader=lines.length>1?lines.slice(1).join("\n"):"";
  if(!noHeader.trim()){showToast("æ²¡æœ‰å¯å¤åˆ¶çš„ TSV");return;}
  await robustCopy(noHeader);showToast("å·²å¤åˆ¶ TSV");
});
el.dlBtn.addEventListener("click",()=>{
  const tsv=el.tableWrap.dataset.tsv||"";if(!tsv.trim()){showToast("æ²¡æœ‰å¯ä¸‹è½½çš„ TSV");return;}
  const blob=new Blob([tsv],{type:"text/tab-separated-values;charset=utf-8"});
  const url=URL.createObjectURL(blob);const a=document.createElement("a");
  a.href=url;a.download="translations.tsv";a.click();URL.revokeObjectURL(url);
});

const presetSelect = document.getElementById("presetPrompt");
const customPromptArea = document.getElementById("customPrompt");

if (presetSelect && customPromptArea) {
  const presets = {
    music: `æ­¤æ¬¡ä»»åŠ¡æ˜¯è¿›è¡ŒAIéŸ³ä¹SAASç½‘ç«™çš„æ–‡æ¡ˆç¿»è¯‘ï¼Œéœ€è¦å°†ä¸ AI éŸ³ä¹åˆ›ä½œã€æ··éŸ³ã€æ¯å¸¦ã€æ­Œè¯æˆ–éŸ³é¢‘å·¥å…·ç›¸å…³çš„æ–‡æœ¬ç¿»è¯‘ä¸ºç›®æ ‡è¯­è¨€ï¼Œä½¿å…¶è‡ªç„¶ã€æœ¬åœ°åŒ–ã€ç¬¦åˆéŸ³ä¹è¡Œä¸šæœ¯è¯­åŠ SEO è¡¨è¾¾ï¼Œé€‚ç”¨äºå…¨çƒéŸ³ä¹ç”Ÿæˆå¹³å°ã€éŸ³é¢‘å·¥å…·ç½‘ç«™å’Œå¤šè¯­è¨€äº§å“é¡µé¢ã€‚\n\nè§„åˆ™ï¼š\n- ä¿ç•™åŸæ–‡æ ¼å¼ä¸æ’ç‰ˆï¼Œä¸å¢åˆ å†…å®¹ã€‚\n- JSONæ ¼å¼çš„æ•°æ®è¦ä¿ç•™åŸæœ‰ç»“æ„ï¼Œä¸èƒ½å½±å“å¼€å‘ï¼ŒåŒ…æ‹¬å…¨éƒ¨çš„[]{}ï¼Œä¿ç•™è‹±æ–‡çš„é€—å·,è‹±æ–‡çš„å¼•å·""ï¼Œjsonä¸­çš„keyä¿ç•™ä¸ç¿»è¯‘ç­‰ç­‰\n- ç¿»è¯‘éœ€å…¼é¡¾éŸ³ä¹åˆ¶ä½œã€AI åˆ›ä½œä¸éŸ³é¢‘å·¥ç¨‹é¢†åŸŸçš„ä¸“ä¸šå‡†ç¡®æ€§ã€‚\n- äº§å“åæˆ–å“ç‰Œåä¿æŒåŸæ–‡ï¼ˆå¦‚ MusicCreator AIã€Sunoã€OpenMusicï¼‰ã€‚\n- ç¼ºå°‘åˆé€‚è¯‘è¯æ—¶å¯ä¿ç•™è‹±æ–‡åŸæ–‡ï¼Œä½†éœ€ç¬¦åˆç›®æ ‡è¯­è¨€è¯­åºã€‚\n- è¯­è¨€é£æ ¼ï¼š\n- ä¸“ä¸šã€è‡ªç„¶ã€é¢å‘åˆ›ä½œè€…ã€åˆ¶ä½œäººã€è‰ºæœ¯å®¶åŠæ™®é€šç”¨æˆ·ã€‚\n- ç”¨è¯åº”æ¸…æ™°ã€ç®€æ´ï¼Œé¿å…è¿‡åº¦è¥é”€æˆ–æœºæ¢°ç›´è¯‘ã€‚\n- å¯¹äºåŸè‹±æ–‡ä¸­çš„è¿è¯ç¬¦ï¼Œéœ€è¦åœ¨ä¸åŒç›®æ ‡è¯­è¨€ä¸‹ç»“åˆå¥æ„ï¼Œè¯­å¢ƒï¼Œè°ƒæ•´å¥½è¡¨è¾¾çš„è¯­åº\n- åœ¨æè¿°åŠŸèƒ½æˆ–æµç¨‹æ—¶ï¼Œåº”é‡‡ç”¨éŸ³ä¹äººå¸¸ç”¨è¡¨è¾¾æ–¹å¼ã€‚\n- è‹¥æ¶‰åŠ SEO æè¿°ï¼Œä¼˜å…ˆä½¿ç”¨è¡Œä¸šä¸­æœç´¢é‡è¾ƒé«˜çš„è‡ªç„¶è¯´æ³•ã€‚\n\nè¯´æ˜ï¼š\n- ä¿ç•™æ‰€æœ‰éŸ³é¢‘å‚æ•°ã€ç¬¦å·ã€å ä½ç¬¦åŠ HTML æ ‡ç­¾ã€‚\n- ç¿»è¯‘éŸ³ä¹åŠŸèƒ½æœ¯è¯­æ—¶éµå¾ªä¸“ä¸šæ ‡å‡†ï¼Œå¦‚ EQã€DAWã€compressorã€vocalã€drum loopã€BPM ç­‰ã€‚\n- è‹¥å‡ºç°æµæ´¾æˆ–é£æ ¼è¯æ±‡ï¼ˆå¦‚ lofiã€phonkã€EDMã€jazzï¼‰ï¼Œä¿æŒåŸæ–‡æ‹¼å†™ã€‚\n- ä¿ç•™éŸ³ä¹å“ç‰Œä¸äº§å“åï¼Œä¸è¿›è¡Œç¿»è¯‘æˆ–æ”¹å†™ã€‚\n- è¯­æ°”åº”ç¬¦åˆéŸ³ä¹å¹³å°é£æ ¼ï¼šåˆ›æ„ã€è‡ªç”±ã€é¼“åŠ±è¡¨è¾¾ã€å…¼å…·ä¸“ä¸šåº¦ã€‚`,
    coloring: `æ­¤æ¬¡ä»»åŠ¡æ˜¯å°†ä¸å¡«è‰²é¡µç›¸å…³çš„æç¤ºè¯ã€æè¿°æˆ–å„¿ç«¥å‹å¥½å‹å›¾åƒè¯´æ˜ç¿»è¯‘ä¸ºç›®æ ‡è¯­è¨€ï¼Œä½¿å…¶è‡ªç„¶ã€æœ¬åœ°åŒ–ã€å…·è§†è§‰æè¿°æ€§ï¼Œé€‚ç”¨äºå…¨çƒå¡«è‰²é¡µç½‘ç«™ã€å›¾åƒç”Ÿæˆæ¨¡å‹åŠå¤šè¯­è¨€å•†å“é¡µé¢ã€‚\n\nè§„åˆ™ï¼š\nä¿ç•™åŸæ–‡çš„æ ¼å¼ä¸æ’ç‰ˆï¼Œä¸å¢åˆ å†…å®¹ã€‚\nä¿ç•™æ‰€æœ‰æŠ€æœ¯è¯æ±‡ï¼ˆå¦‚ outline onlyã€ratio 2:3ã€no shadowã€black and white ç­‰ï¼‰ã€‚\nåŸå§‹çš„è§†è§‰ç»“æ„è¯´æ˜å¿…é¡»å®Œæ•´ä¿ç•™ã€‚\näººç‰©ã€è§’è‰²æˆ– IP åç§°ä½¿ç”¨å„è¯­è¨€ä¸­æœ€å¸¸ç”¨ã€å®˜æ–¹æˆ–å¹¿ä¸ºäººçŸ¥çš„åç§°ï¼Œé¿å…ç›´è¯‘æˆ–éŸ³è¯‘ã€‚\nå½“ç›®æ ‡è¯­è¨€ä¸­ç¼ºå°‘å¯¹åº”æœ¯è¯­æ—¶ï¼Œå¯ä¿ç•™è‹±æ–‡åŸæ–‡ã€‚\n\nè¯­è¨€é£æ ¼ï¼š\næ¸©å’Œã€æœ‰æƒ³è±¡åŠ›ã€å…·è§†è§‰æ„Ÿã€‚\né¢å‘å„¿ç«¥ã€å®¶é•¿æˆ–åˆ›ä½œè€…ã€‚\nè‹¥ä¸º AI å›¾åƒæç¤ºï¼Œåº”ç®€æ´ã€æ¸…æ™°ã€‚\né¿å…ç”Ÿç¡¬ç›´è¯‘æˆ–æœºæ¢°è¡¨è¾¾ã€‚\n\nç¿»è¯‘æµç¨‹ï¼š\nâ‘  ç›´è¯‘ï¼ˆLiteral Translationï¼‰ï¼šé€å­—é€å¥ç¿»è¯‘ï¼Œä¿ç•™ç»“æ„ã€æŠ€æœ¯è¯ã€æ’ç‰ˆã€‚\nâ‘¡ è¯„ä¼°ä¸åæ€ï¼ˆEvaluation and Reflectionï¼‰ï¼šç®€è¦è¯´æ˜ç›´è¯‘ä¸­çš„é—®é¢˜ï¼ŒåŒ…æ‹¬ä¸è‡ªç„¶è¡¨è¾¾ã€è§†è§‰è¯­ä¹‰æ˜¯å¦å‡†ç¡®ã€æŠ€æœ¯æè¿°æ˜¯å¦æ¸…æ™°ã€‚\nâ‘¢ æœ¬åœ°åŒ–è¯‘æ–‡ï¼ˆFree Translationï¼‰ï¼šåŸºäºåæ€é‡æ–°ç¿»è¯‘ï¼Œä½¿è¯­æ°”è‡ªç„¶ã€ç”ŸåŠ¨ã€æ–‡åŒ–å¥‘åˆï¼ŒåŒæ—¶ä¿æŒè§†è§‰ä¸æŠ€æœ¯å‡†ç¡®æ€§ã€‚\n\nè¯´æ˜ï¼š\nä¿ç•™è§’è‰²åã€æ–‡åŒ–åè¯ã€å›¾åƒç‰¹å¾ã€‚\nè‹¥æ–‡æœ¬æè¿°åœºæ™¯ï¼Œåº”å…·ç”»é¢æ„Ÿä¸æ•…äº‹æ€§ã€‚\nå¯¹äºçŸ¥åè§’è‰²ï¼ˆå¦‚ Spidermanã€Elsaã€Hello Kittyï¼‰ï¼Œä½¿ç”¨å½“åœ°å¸¸ç”¨æˆ–å®˜æ–¹åç§°ã€‚\nè‹¥ä¸ç¡®å®šï¼Œé‡‡ç”¨è¯¥è¯­è¨€ä¸­æœç´¢é‡æœ€é«˜çš„ç‰ˆæœ¬ï¼Œä¸å¯éšæ„éŸ³è¯‘ã€‚`
  };
  presetSelect.addEventListener("change", () => {
    const v = presetSelect.value;
    if (v && presets[v]) customPromptArea.value = presets[v];
    else customPromptArea.value = "";
  });
}

const examplePreset = document.getElementById("examplePreset");
const bestExamplesArea = document.getElementById("bestExamples");
if (examplePreset && bestExamplesArea) {
    const examplePresets = {
    music: `è‹±è¯­	ja	de	pt	es	fr	ko	vi\nbeats	æ‰“ã¡è¾¼ã¿ éŸ³æ¥½	beats	batidas	ritmos	Beats	beats	nhá»‹p Ä‘iá»‡u\nFREE	ç„¡æ–™	Kostenlos	GrÃ¡tis	Gratis	Gratuit	ë¬´ë£Œ	miá»…n phÃ­`,
    coloring: `å¾…è¡¥å……`
  };
  examplePreset.addEventListener("change", () => {
    const v = examplePreset.value;
    if (v && examplePresets[v]) bestExamplesArea.value = examplePresets[v];
    else bestExamplesArea.value = "";
  });
}

// ç¤ºä¾‹é¢„è§ˆ
const previewBtn = document.getElementById("previewExampleBtn");
const modal = document.getElementById("examplePreviewModal");
const closeBtn = document.getElementById("closePreviewBtn");
const exampleTable = document.getElementById("examplePreviewTable");

function parseTSVToTable(tsvText) {
  const rows = tsvText.trim().split(/\r?\n/).map(r => r.split("\t"));
  const thead = exampleTable.querySelector("thead");
  const tbody = exampleTable.querySelector("tbody");
  thead.innerHTML = ""; tbody.innerHTML = "";
  if (rows.length === 0) return;

  const headerRow = document.createElement("tr");
  rows[0].forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    th.className = "px-6 py-3 bg-white/60 font-bold text-slate-700 border-b border-white/40 sticky top-0 backdrop-blur-sm";
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  rows.slice(1).forEach(r => {
    const tr = document.createElement("tr");
    r.forEach(c => {
      const td = document.createElement("td");
      td.textContent = c;
      td.className = "px-6 py-2 border-b border-white/20 text-slate-600";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

if (previewBtn && modal && closeBtn) {
  previewBtn.addEventListener("click", () => {
    const text = document.getElementById("bestExamples").value.trim();
    if (!text) { showToast("æ²¡æœ‰å¯é¢„è§ˆçš„ç¤ºä¾‹å†…å®¹"); return; }
    parseTSVToTable(text);
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  });
  closeBtn.addEventListener("click", () => {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  });
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
  });
}

const tableBody = document.querySelector("#resultTable tbody");
if (tableBody) {
  tableBody.addEventListener("click", async (e) => {
    const td = e.target.closest("td");
    if (!td) return;
    const text = td.textContent.trim();
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      showToast("å·²å¤åˆ¶");
      td.classList.add("bg-green-100/60");
      setTimeout(() => td.classList.remove("bg-green-100/60"), 500);
    } catch {
      showToast("å¤åˆ¶å¤±è´¥");
    }
  });
}
</script>
</body>
</html>
